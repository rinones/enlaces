import { $all, fetchJSON } from './utils.js';

export function markActiveNav(){ try{ const links=$all('.main-nav .nav-link'); if(!links.length) return; const path=(location.pathname||'').split('/').pop()||'index.html'; links.forEach(el=>{ try{ const raw=el.getAttribute('href')||''; const url=new URL(raw, location.href); if(url.origin!==location.origin){ el.classList.remove('active'); return; } const href=(url.pathname||'').split('/').pop()||'index.html'; if(href===path){ el.classList.add('active'); } else { el.classList.remove('active'); } }catch(_){ el.classList.remove('active'); } }); }catch(_){} }

export function enhanceNavDropdowns(){
  function closest(el, sel){ while(el && el.nodeType===1){ if(el.matches(sel)) return el; el=el.parentElement; } return null; }
  function closeAll(){ $all('.main-nav .dropdown.open').forEach(d=>{ d.classList.remove('open'); const btn=d.querySelector('.dropdown-toggle'); if(btn){ btn.setAttribute('aria-expanded','false'); btn.blur(); } }); }
  function setup(drop){ const btn=drop.querySelector('.dropdown-toggle'); const menu=drop.querySelector('.dropdown-menu'); if(!btn||!menu) return; btn.addEventListener('focus', ()=>{ drop.classList.add('open'); btn.setAttribute('aria-expanded','true'); }); btn.addEventListener('blur', ()=>{ drop.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }); menu.addEventListener('click', e=>e.stopPropagation()); }
  $all('.main-nav .dropdown').forEach(setup);
  document.addEventListener('click', e=>{ if(!closest(e.target, '.main-nav .dropdown')) closeAll(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAll(); });
}

export function buildUnedDropdown(){ try{ const container=document.querySelector('.main-nav .dropdown[data-menu="uned"] .mega-sections'); if(!container) return; function renderGroups(groups){ container.innerHTML=''; if(!groups||!groups.length){ const sec=document.createElement('div'); sec.className='mega-section'; const title=document.createElement('div'); title.className='mega-title'; title.textContent='Asignaturas'; const list=document.createElement('div'); list.className='mega-list'; [ {nombre:'PREDA', href:'uned.html#preda'}, {nombre:'REDES', href:'uned.html#redes'} ].sort((a,b)=>a.nombre.localeCompare(b.nombre,'es',{sensitivity:'base'})).forEach(it=>{ const a=document.createElement('a'); a.href=it.href; a.className='dropdown-item'; a.textContent=it.nombre; list.appendChild(a); }); sec.appendChild(title); sec.appendChild(list); container.appendChild(sec); return; } groups.sort((g1,g2)=> (g1.curso||0)-(g2.curso||0) || (g1.cuatrimestre||0)-(g2.cuatrimestre||0)); groups.forEach(g=>{ const sec=document.createElement('div'); sec.className='mega-section'; const t=(g.curso?(g.curso+'º'):'') + (g.cuatrimestre?(' · '+(g.cuatrimestre===1?'1er':'2º')+' cuatrimestre'):''); const title=document.createElement('div'); title.className='mega-title'; title.textContent=t||'Asignaturas'; const list=document.createElement('div'); list.className='mega-list'; const items=Array.isArray(g.asignaturas)?g.asignaturas.slice():[]; items.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||'','es',{sensitivity:'base'})); items.forEach(it=>{ const a=document.createElement('a'); a.href=it.href; a.className='dropdown-item'; a.textContent=it.nombre; list.appendChild(a); }); sec.appendChild(title); sec.appendChild(list); container.appendChild(sec); }); }
  fetchJSON('data/uned-subjects.json').then(json=>{ if(json && Array.isArray(json)) renderGroups(json); else renderGroups([]); }); }catch(_){} }
